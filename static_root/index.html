<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TinyLinks</title>
    <style>
      :root { color-scheme: light dark; }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        margin: 0;
        padding: 2rem;
        display: grid;
        place-items: center;
        min-height: 100dvh;
        background-image: url('background.jpg');
        background-repeat: no-repeat;
        background-position: center center;
        background-attachment: fixed;
        background-size: auto 100vh;
      }
      .card {
        width: min(420px, 100%);
        border: 1px solid #34425655; /* slightly darker */
        border-radius: 14px;
        padding: 1.25rem 1.25rem 1.25rem 1.25rem;
        box-shadow: 0 8px 24px rgba(0,0,0,.14);
        background: linear-gradient(180deg, rgba(236,240,248,.96), rgba(220,228,242,.92)); /* darker to pop white logo */
        color: #0f172a;
        position: relative;
        backdrop-filter: saturate(120%) blur(2px);
      }
      .brand { display: block; width: 100%; height: auto; margin: 0 0 0 0; border-radius: 14px; }
      .title { font-size: 1.5rem; font-weight: 700; padding: 1.25rem; text-align: center; background-color: #0b1220; color: #fff; border-radius: 14px; }
      .desc { opacity: 0.85; margin: 0; }
      .row { display: flex; flex-direction: column; gap: 0.6rem; }

      /* Buttons */
      .btn {
        display: inline-flex;
        gap: .5rem;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: .8rem 1rem;
        border-radius: 10px;
        border: 1px solid rgba(23,32,53,.45); /* a tad darker */
        background: linear-gradient(180deg, #eef1f7 0%, #dde3ee 100%); /* slightly darker */
        color: #0f172a;
        cursor: pointer;
        font-size: 1rem;
        box-shadow:
          0 2px 0 rgba(17, 24, 39, .05),
          0 6px 14px rgba(15, 23, 42, .2),
          inset 0 1px 0 rgba(255,255,255,.7);
        transition: box-shadow .18s ease, transform .12s ease, filter .18s ease;
      }
      .btn:hover { filter: brightness(1.01); transform: translateY(-1px); box-shadow: 0 3px 0 rgba(17,24,39,.06), 0 10px 22px rgba(15,23,42,.26), inset 0 1px 0 rgba(255,255,255,.8); }
      .btn:active { transform: translateY(0); box-shadow: 0 1px 0 rgba(17,24,39,.05), 0 6px 14px rgba(15,23,42,.2), inset 0 1px 0 rgba(255,255,255,.65); }

      .icon-btn {
        display: inline-flex;
        gap: .5rem;
        align-items: center;
        justify-content: center;
        padding: .45rem .65rem;
        border-radius: 8px;
        border: 1px solid rgba(23,32,53,.45);
        background: linear-gradient(180deg, #eef1f7 0%, #dde3ee 100%);
        color: #0f172a;
        cursor: pointer;
        font-size: .95rem;
        width: auto;
        box-shadow: 0 4px 10px rgba(15,23,42,.18), inset 0 1px 0 rgba(255,255,255,.7);
        transition: box-shadow .18s ease, transform .12s ease, filter .18s ease;
      }
      .icon-btn:hover { filter: brightness(1.02); transform: translateY(-1px); }
      .icon-btn:active { transform: translateY(0); }

      .muted { opacity: .7; font-size: .9rem; }
      .error { color: #c0392b; font-weight: 600; }
      .hidden { display: none; }

      /* Modal */
      .modal { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: grid; place-items: center; padding: 1rem; }
      .modal.hidden { display: none; }
      .modal-content { width: min(420px, 100%); background: linear-gradient(180deg, #eaf0fb, #dde6f4); color: #0b1220; border: 1px solid rgba(23,32,53,.25); border-radius: 12px; padding: 1rem; box-shadow: 0 10px 36px rgba(0,0,0,.25); }
      .modal h2 { margin: 0 0 .5rem 0; font-size: 1.25rem; text-align: center; }
      .modal label { display: block; font-weight: 600; margin: .5rem 0 .25rem; text-align: center; }
      .modal input[type="text"] { width: 14ch; display:block; margin: 0 auto; padding: .6rem .7rem; border: 1px solid rgba(0,0,0,.2); border-radius: 10px; font-size: 1.1rem; letter-spacing: .1em; text-align: center; background: linear-gradient(180deg, #f8f9fd, #eef2f9); }
      .modal .modal-actions { display: flex; gap: .5rem; justify-content: center; margin-top: .9rem; }

      .toolbar { display: none; }
      .code-indicator { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

      /* Subheader for desc + tools inline */
      .subheader { display: flex; align-items: center; justify-content: space-between; gap: .5rem; margin: .25rem 0 1rem 0; }
      .subtools { display: inline-flex; align-items: center; gap: .5rem; }
    </style>
  </head>
  <body>
    <div class="card">
      <!-- Banner -->
	  <h1 id="title" class="title">TinyLinks</h1>

      <div class="subheader">
        <p id="desc" class="desc">Sign in with your provider</p>
        <div class="subtools" aria-label="TinyLink tools">
          <button id="linkcode-btn" class="icon-btn" type="button" aria-haspopup="dialog" aria-controls="linkcode-modal" aria-label="Enter TinyLink Code">
            <!-- chain icon -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
              <path d="M10.59 13.41a2 2 0 0 0 2.82 0l3.59-3.59a2 2 0 0 0 0-2.82a2 2 0 0 0-2.82 0l-1.17 1.17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M13.41 10.59a2 2 0 0 0-2.82 0l-3.59 3.59a2 2 0 0 0 0 2.82a2 2 0 0 0 2.82 0l1.17-1.17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>TinyLink Code</span>
          </button>
          <span id="linkcode-display" class="muted code-indicator hidden" aria-live="polite"></span>
        </div>
      </div>

      <div id="login" class="row">
        <div id="buttons" class="row"></div>
      </div>

      <p id="error" class="error hidden"></p>
    </div>

    <!-- TinyLink Code Modal -->
    <div id="linkcode-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="linkcode-title">
      <div class="modal-content">
        <h2 id="linkcode-title">Enter TinyLink Code</h2>
        <label for="linkcode-input">TinyLink Code (8 characters)</label>
        <input id="linkcode-input" type="text" inputmode="latin" autocomplete="one-time-code" maxlength="8" aria-describedby="linkcode-help" />
        <div id="linkcode-help" class="muted">Enter the 8-character code. Letters and numbers only.</div>
        <div id="linkcode-error" class="error hidden"></div>
        <div class="modal-actions">
          <button id="linkcode-cancel" type="button" class="btn">Cancel</button>
          <button id="linkcode-save" type="button" class="btn">Save</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const byId = (id) => document.getElementById(id);
        const setError = (msg) => { const el = byId('error'); el.textContent = msg; el.classList.remove('hidden'); };
        const clearError = () => { byId('error').classList.add('hidden'); byId('error').textContent = ''; };

        let linkCode = '';
        let lastFocus = null;

        function openLinkCodeModal() {
          const modal = byId('linkcode-modal');
          const input = byId('linkcode-input');
          const err = byId('linkcode-error');
          err.textContent = ''; err.classList.add('hidden');
          input.value = linkCode;
          modal.classList.remove('hidden');
          lastFocus = document.activeElement;
          setTimeout(() => input.focus(), 0);

          function onKeyDown(e) {
            if (e.key === 'Escape') { e.preventDefault(); closeLinkCodeModal(); }
          }
          modal.dataset.keyHandler = '1';
          document.addEventListener('keydown', onKeyDown, { once: true });
        }

        function closeLinkCodeModal() {
          const modal = byId('linkcode-modal');
          modal.classList.add('hidden');
          if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
        }

        function validateAndSaveLinkCode() {
          const input = byId('linkcode-input');
          const err = byId('linkcode-error');
          const display = byId('linkcode-display');
          const val = (input.value || '').trim().toUpperCase();

          // Enforce 8 characters, alphanumeric
          const ok = /^[A-Z0-9]{8}$/.test(val);
          if (!ok) {
            err.textContent = 'Code must be exactly 8 letters/numbers.';
            err.classList.remove('hidden');
            return;
          }

          linkCode = val;
          display.textContent = 'Code: ' + linkCode;
          display.classList.remove('hidden');
          closeLinkCodeModal();
        }

        // Keep input uppercase and <= 8 chars
        byId('linkcode-input').addEventListener('input', (e) => {
          e.target.value = (e.target.value || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 8);
        });
        byId('linkcode-btn').addEventListener('click', openLinkCodeModal);
        byId('linkcode-cancel').addEventListener('click', closeLinkCodeModal);
        byId('linkcode-save').addEventListener('click', validateAndSaveLinkCode);

        const startOAuth = (provider) => {
          clearError();
          try {
            // Build upstream URL, carry through current authorize params, and optional link code
            let urlStr = `/api/oauth/upstream?provider=${encodeURIComponent(provider)}`;
            const search = window.location.search;
            if (search && search.length > 1) {
              urlStr += `&${search.slice(1)}`;
            }
            if (linkCode && linkCode.length === 8) {
              urlStr += `&linkcode=${encodeURIComponent(linkCode)}`;
            }
            window.location.href = urlStr;
          } catch (e) {
            setError('Failed to start OAuth. Please try again.');
            console.error(e);
          }
        };

        // Icons
        function iconDiscord() {
          const img = document.createElement('img');
          img.src = 'Discord.svg';
          img.alt = 'Discord';
          img.width = 20;
          img.height = 20;
          img.decoding = 'async';
          img.loading = 'eager';
          return img;
        }
        function iconGoogle() {
          return `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 262">
              <path fill="#4285f4" d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622l38.755 30.023l2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"/>
              <path fill="#34a853" d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055c-34.523 0-63.824-22.773-74.269-54.25l-1.531.13l-40.298 31.187l-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"/>
              <path fill="#fbbc05" d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82c0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602z"/>
              <path fill="#eb4335" d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0C79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"/>
            </svg>
          `;
        }
        function iconAlways() {
          const img = document.createElement('img');
          img.src = 'tinylinks.png';
          img.alt = 'Always Admin';
          img.width = 20;
          img.height = 20;
          img.decoding = 'async';
          img.loading = 'eager';
          return img;
        }

        const renderButtons = (providers) => {
          const container = byId('buttons');
          container.innerHTML = '';
          const names = { google: 'Google', discord: 'Discord', always: 'Always Admin' };
          const icons = { google: iconGoogle, discord: iconDiscord, always: iconAlways };
          providers.forEach((p) => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.type = 'button';
            btn.setAttribute('aria-label', `Sign in with ${names[p] || p}`);
            const ico = (icons[p] || (()=>document.createTextNode('')) )();
            const label = document.createElement('span');
            label.textContent = names[p] || p;
            if (typeof ico === 'string') {
              btn.innerHTML += ico;
            } else {
              btn.appendChild(ico);
            }
            btn.appendChild(label);
            btn.onclick = () => startOAuth(p);
            container.appendChild(btn);
          });
        };

        // Fixed list for now; server controls final redirect
        renderButtons(['google', 'discord', 'always']);
      })();
    </script>
  </body>
</html>
